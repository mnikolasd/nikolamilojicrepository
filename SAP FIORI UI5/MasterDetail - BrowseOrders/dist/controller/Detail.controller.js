sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/library","sap/ui/Device","sap/m/MessageToast"],function(e,t,i,o,n,r){"use strict";var s=o.URLHelper;return e.extend("opensap.orders.controller.Detail",{formatter:i,onInit:function(){var e=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("Info").attachPatternMatched(this._onObjectMatched,this);this.getRouter().getRoute("create").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},onCreate:function(e){var t=!n.system.phone;this.getRouter().navTo("create",{objectId:e.getSource().getBindingContext().getProperty("SalesOrderID")},t)},onSendEmailPress:function(){var e=this.getModel("detailView");s.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},onConfirm:function(e){var t=e.getSource().getBindingContext().getObject();var i=this.getResourceBundle().getText("OrderPreparationMessage",[t.CustomerID,t.CustomerName]);r.show(i)},onListUpdateFinished:function(e){var t,i=e.getParameter("total"),o=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(i){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[i])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}o.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;if(!t){return}if(e.getParameter("name")==="object"){this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded")}this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("SalesOrderSet",{SalesOrderID:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var i=t.getPath(),o=this.getResourceBundle(),n=e.getModel().getObject(i),r=n.SalesOrderID,s=n.CustomerName,a=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(i);a.setProperty("/shareSendEmailSubject",o.getText("shareSendEmailObjectSubject",[r]));a.setProperty("/shareSendEmailMessage",o.getText("shareSendEmailObjectMessage",[s,r,location.href]))},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),i=this.byId("lineItemsList"),o=i.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);i.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",o)});t.setProperty("/busy",true);t.setProperty("/delay",e)},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.byId("lineItemsList").removeSelections(true);this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}},action:function(e){var t=!n.system.phone;this.getRouter().navTo("Info",{objectId:(e.getParameter("listItem")||e.getSource()).getBindingContext().getProperty("SalesOrderID"),itemPosition:(e.getParameter("listItem")||e.getSource()).getBindingContext().getProperty("ItemPosition")},t)},onDelete:function(e){var t=e.getParameter("draggedControl");if(!t){var i=this.byId("lineItemsList");t=i.getSelectedItem()||i.getItems()[0]}var o=t.getBindingContextPath(),n=t.getBindingContext().getProperty("ProductID");this._confirmDelete(o,n)},_confirmDelete:function(e,t){var i=this.getResourceBundle();sap.ui.require(["sap/m/MessageBox"],function(o){o.confirm(i.getText("deleteConfirmationMessage",[t]),{title:i.getText("confirmTitle"),onClose:function(t){if(t==="OK"){this.getModel().remove(e,{success:function(){r.show(i.getText("deleteSuccessMessage"))},error:function(){o.error(i.getText("deleteErrorMessage"))}})}}.bind(this)})}.bind(this))}})});